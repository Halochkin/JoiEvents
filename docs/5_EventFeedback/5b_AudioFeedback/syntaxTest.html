<script type="module">
  import {parse} from "./cssAudioParser.js";
  import {interpret} from "./cssAudioInterpreter.js";

  let a = "a > b > c";
  let a_ = '{"type":"pipe","nodes":["a","b","c"]}';
  let b = "a > --audio-var > c";
  let b_ = '{"type":"pipe","nodes":["a","--audio-var","c"]}';
  let c = "a > b > [c, d]";
  let c_ = '{"type":"pipe","nodes":["a","b",["c","d"]]}';
  let d = "sawtooth(144hz) > lowpass(140hz, 24dB)";
  let d_ = '{"type":"pipe","nodes":[{"type":"fun","name":"sawtooth","args":[{"num":"144","unit":"hz"}]},{"type":"fun","name":"lowpass","args":[{"num":"140","unit":"hz"},{"num":"24","unit":"dB"}]}]}';
  let e = "square(144hz) > vol([1/0.0015],[0.6/0.001],[0.6/1],[0/0.03]) > lowpass(180hz, 12dB)";
  let e_ = '{"type":"pipe","nodes":[{"type":"fun","name":"square","args":[{"num":"144","unit":"hz"}]},{"type":"fun","name":"vol","args":[[[{"num":"1","unit":""},{"num":"0.0015","unit":""}]],[[{"num":"0.6","unit":""},{"num":"0.001","unit":""}]],[[{"num":"0.6","unit":""},{"num":"1","unit":""}]],[[{"num":"0","unit":""},{"num":"0.03","unit":""}]]]},{"type":"fun","name":"lowpass","args":[{"num":"180","unit":"hz"},{"num":"12","unit":"dB"}]}]}';
  let f = "url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3)";
  let f_ = '{"type":"pipe","nodes":[{"type":"fun","name":"url","args":["https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3"]}]}';
  let g = "url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3) > lowpass(180hz, 12dB)";
  let g_ = '{"type":"pipe","nodes":[{"type":"fun","name":"url","args":["https://s3-us-west-2.amazonaws.com/s.cdpn.io/355309/G4.mp3"]},{"type":"fun","name":"lowpass","args":[{"num":"180","unit":"hz"},{"num":"12","unit":"dB"}]}]}';


  function test(msg, tst) {
    let obj = parse(msg);
    let stringify = JSON.stringify(obj);
    if (tst === stringify)
      console.log("success: ", msg, obj);
    else
      console.error("error: ", msg, obj);
  }

  test(a, a_);
  test(b, b_);
  test(c, c_);
  test(d, d_);
  test(e, e_);
  test(f, f_);
  test(g, g_);

  async function onClick(){
//    let x = "sine(340hz) > gain(0.2)"; //works
//    let x = "sine(340hz) > gain(square(2hz))"; //works
//    let x = "sine(340hz) > gain([0.9/0.9, 0.6/0.001, 0.6/0.4, 0/0.02])"; //works
    const ctx = await interpret(g);
    ctx.resume();
    setTimeout(function(){
      ctx.suspend();
    }, 2000);
  }
  window.addEventListener("click", onClick);

//  async function onClick2(e){
//    e.stopPropagation();
//    const buffer = await interpret2(g);
//    const audioCtx = new AudioContext();
//    const bufferSource = audioCtx.createBufferSource();
//    bufferSource.buffer = buffer;
//    bufferSource.connect(audioCtx.destination);
//    setTimeout(function(){
//      audioCtx.suspend();
//    }, 4000);
//  }
//  document.querySelector("pre").addEventListener("click", onClick2);
</script>

<pre>here the beautiful sounds! (sic.)</pre>