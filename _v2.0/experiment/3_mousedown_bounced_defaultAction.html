<script type="module">

  import {toggleTick} from "../src/joi2.js";//todo we need to make sure we have setDefault in this test.

  class BouncedMousedown {

    constructor(root) {
      this.root = root;
      this._onMousedown = this.onMousedown.bind(this);
    }

    connect() {
      this.root.addGuaranteedBubbleListener("mousedown", this._onMousedown);
    }

    disconnect() {
      this.root.removeGuaranteedBubbleListener("mousedown", this._onMousedown);
    }

    onMousedown(e) {
      this.defaultAction = undefined;
      const bounceMousedown = new MouseEvent("bounced-mousedown", {bubbles: true});
      const target = e.currentTarget === window ? e.currentTarget : e.target;
      const myRoot = target.getRootNode ? target.getRootNode() : target;//todo this is the origin of the event. So this I should be able to query from the event itself.
      //const myRoot = e.origin;//todo
      toggleTick(function () {
        //this is not necessary here.. how do i control for the order of the mousedowns..
        //todo how do i make the function ensure that it is the same bounced event sequence. Not some lingering defaultAction
        if (this.defaultAction)
          bounceMousedown._defaultAction = this.defaultAction;
        target.dispatchEvent(bounceMousedown);
        if (!bounceMousedown._defaultAction)
          return;
        //todo here it might be a question if we should do a event.bounceDefaultAction()???
        //     And then it would be possible to do a bounceOrRunDefaultAction()...
        if (!myRoot.bounceDefaultAction(bounceMousedown.type, bounceMousedown._defaultAction))
          bounceMousedown._defaultAction(bounceMousedown);
        //todo this is a bit fragile. The default action might be passed to an inactive event controller,
        //     that will implicitly either delay it or loose it. and here there can be version conflicts.
        //todo we must assume that event controllers with the same handle name will want to pass default
        //     actions to each other.
      }.bind(this));
    }
  }

  class WebComp extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({mode: "open"});
      this.shadowRoot.innerHTML = "<h1>hello sunshine</h1><h2>nothing here</h2>";
      const h1 = this.shadowRoot.children[0];
      h1.addEventListener("bounced-mousedown", e => e.setDefault(e => console.log("defaultAction from WebComp" + e.type)));
    }
  }

  //define event controller on the window.
  window.defineEvent("bounced-mousedown", BouncedMousedown);
  //define custom element
  customElements.define("web-comp", WebComp);

  window.addEventListener("bounced-mousedown", e => console.log(e.target, e.version));
</script>

<web-comp></web-comp>